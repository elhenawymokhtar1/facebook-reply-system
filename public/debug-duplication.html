<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” ØªØªØ¨Ø¹ Ù…Ø´ÙƒÙ„Ø© ØªÙƒØ±Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #007bff;
        }
        
        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .button.danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }
        
        .button.success {
            background: linear-gradient(135deg, #51cf66, #40c057);
        }
        
        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            border: 2px solid #333;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
        }
        
        .log-entry.info {
            color: #00bfff;
        }
        
        .log-entry.success {
            color: #00ff00;
        }
        
        .log-entry.warning {
            color: #ffa500;
        }
        
        .log-entry.error {
            color: #ff4444;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-top: 4px solid #007bff;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .input-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .message-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        
        .message-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        
        .message-item.admin {
            background: #e3f2fd;
            border-left-color: #2196f3;
        }
        
        .message-item.bot {
            background: #f3e5f5;
            border-left-color: #9c27b0;
        }
        
        .message-item.customer {
            background: #e8f5e8;
            border-left-color: #4caf50;
        }
        
        .message-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .message-content {
            font-weight: bold;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” ØªØªØ¨Ø¹ Ù…Ø´ÙƒÙ„Ø© ØªÙƒØ±Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h1>
            <p>Ø£Ø¯Ø§Ø© ØªØ´Ø®ÙŠØµ Ø´Ø§Ù…Ù„Ø© Ù„ÙÙ‡Ù… Ø³Ø¨Ø¨ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</p>
        </div>
        
        <div class="content">
            <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© -->
            <div class="section">
                <h3>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalMessages">0</div>
                        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="duplicateMessages">0</div>
                        <div class="stat-label">Ø±Ø³Ø§Ø¦Ù„ Ù…ÙƒØ±Ø±Ø©</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="adminMessages">0</div>
                        <div class="stat-label">Ø±Ø³Ø§Ø¦Ù„ Admin</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="botMessages">0</div>
                        <div class="stat-label">Ø±Ø³Ø§Ø¦Ù„ Bot</div>
                    </div>
                </div>
            </div>
            
            <!-- Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© -->
            <div class="section">
                <h3>ğŸ“¤ Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©</h3>
                <div class="input-group">
                    <label for="conversationSelect">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:</label>
                    <select id="conversationSelect">
                        <option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="messageText">Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</label>
                    <textarea id="messageText" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù‡Ù†Ø§...">ğŸ§ª Ø±Ø³Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù„ØªØªØ¨Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±</textarea>
                </div>
                <button class="button success" onclick="sendTestMessage()">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø±</button>
                <button class="button" onclick="refreshMessages()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</button>
            </div>
            
            <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£Ø®ÙŠØ±Ø© -->
            <div class="section">
                <h3>ğŸ“¨ Ø¢Ø®Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h3>
                <div class="message-list" id="messagesList">
                    <div class="loading" id="messagesLoading">
                        <div class="spinner"></div>
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</p>
                    </div>
                </div>
            </div>
            
            <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ´Ø®ÙŠØµ -->
            <div class="section">
                <h3>ğŸ”§ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ´Ø®ÙŠØµ</h3>
                <button class="button" onclick="checkDuplicates()">ğŸ” ÙØ­Øµ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙƒØ±Ø±Ø©</button>
                <button class="button" onclick="analyzeTimestamps()">â° ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø·ÙˆØ§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠØ©</button>
                <button class="button" onclick="checkDatabaseIntegrity()">ğŸ—„ï¸ ÙØ­Øµ Ø³Ù„Ø§Ù…Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                <button class="button danger" onclick="clearLogs()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
            </div>
            
            <!-- Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« -->
            <div class="section">
                <h3>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h3>
                <div class="log-container" id="logContainer">
                    <div class="log-entry info">ğŸš€ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø£Ø¯Ø§Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ Ø¨Ù†Ø¬Ø§Ø­</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
        let conversations = [];
        let messages = [];
        let stats = {
            total: 0,
            duplicates: 0,
            admin: 0,
            bot: 0
        };

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ”„ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');
            loadConversations();
            loadMessages();
        });

        // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString('ar-EG');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
        async function loadConversations() {
            try {
                log('ğŸ“ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª...', 'info');
                
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Supabase client Ù…Ù† Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                const response = await fetch('http://localhost:3004/api/conversations');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                conversations = data;
                
                const select = document.getElementById('conversationSelect');
                select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø©...</option>';
                
                conversations.forEach(conv => {
                    const option = document.createElement('option');
                    option.value = conv.id;
                    option.textContent = `${conv.customer_name} (${conv.id.slice(0, 8)}...)`;
                    select.appendChild(option);
                });
                
                log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${conversations.length} Ù…Ø­Ø§Ø¯Ø«Ø©`, 'success');
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª: ${error.message}`, 'error');
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        async function loadMessages() {
            try {
                log('ğŸ“¨ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...', 'info');
                document.getElementById('messagesLoading').style.display = 'block';

                const response = await fetch('http://localhost:3004/api/messages/recent');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                messages = data;

                displayMessages();
                updateStats();

                log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${messages.length} Ø±Ø³Ø§Ù„Ø©`, 'success');
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: ${error.message}`, 'error');
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø¨Ø¯ÙŠÙ„
                await loadMessagesAlternative();
            } finally {
                document.getElementById('messagesLoading').style.display = 'none';
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©
        async function loadMessagesAlternative() {
            try {
                log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©...', 'warning');
                log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹', 'warning');
            } catch (error) {
                log(`âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø¯ÙŠÙ„: ${error.message}`, 'error');
            }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        function displayMessages() {
            const container = document.getElementById('messagesList');
            container.innerHTML = '';

            if (messages.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</p>';
                return;
            }

            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message-item ${message.sender_type}`;

                const timeAgo = getTimeAgo(message.created_at);
                const customerName = message.customer_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';

                messageDiv.innerHTML = `
                    <div class="message-meta">
                        <strong>${getSenderLabel(message.sender_type)}</strong> â€¢
                        ${customerName} â€¢
                        ${timeAgo} â€¢
                        ID: ${message.id.slice(0, 8)}...
                        ${message.facebook_message_id ? ` â€¢ FB: ${message.facebook_message_id.slice(0, 8)}...` : ''}
                    </div>
                    <div class="message-content">${message.content}</div>
                `;

                container.appendChild(messageDiv);
            });
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        function updateStats() {
            stats.total = messages.length;
            stats.admin = messages.filter(m => m.sender_type === 'admin').length;
            stats.bot = messages.filter(m => m.sender_type === 'bot').length;

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙƒØ±Ø±Ø©
            const duplicates = findDuplicates();
            stats.duplicates = duplicates.length;

            document.getElementById('totalMessages').textContent = stats.total;
            document.getElementById('duplicateMessages').textContent = stats.duplicates;
            document.getElementById('adminMessages').textContent = stats.admin;
            document.getElementById('botMessages').textContent = stats.bot;
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙƒØ±Ø±Ø©
        function findDuplicates() {
            const duplicates = [];
            const seen = new Map();

            messages.forEach(message => {
                const key = `${message.content}_${message.conversation_id}_${message.sender_type}`;

                if (seen.has(key)) {
                    const original = seen.get(key);
                    const timeDiff = Math.abs(new Date(message.created_at) - new Date(original.created_at));

                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø£Ù‚Ù„ Ù…Ù† 60 Ø«Ø§Ù†ÙŠØ©ØŒ ÙÙ‡ÙŠ Ù…ÙƒØ±Ø±Ø©
                    if (timeDiff < 60000) {
                        duplicates.push({
                            original,
                            duplicate: message,
                            timeDiff: timeDiff / 1000 // Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
                        });
                    }
                } else {
                    seen.set(key, message);
                }
            });

            return duplicates;
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø±
        async function sendTestMessage() {
            const conversationId = document.getElementById('conversationSelect').value;
            const messageText = document.getElementById('messageText').value;

            if (!conversationId) {
                log('âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­Ø§Ø¯Ø«Ø© Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }

            if (!messageText.trim()) {
                log('âŒ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'error');
                return;
            }

            try {
                log(`ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø±...`, 'info');

                const response = await fetch('http://localhost:3004/api/send-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        conversation_id: conversationId,
                        content: messageText,
                        sender_type: 'admin'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    log(`âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­`, 'success');

                    // Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„ Ø«Ù… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                    setTimeout(() => {
                        refreshMessages();
                    }, 2000);
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${error.message}`, 'error');
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        function refreshMessages() {
            log('ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...', 'info');
            loadMessages();
        }

        // ÙØ­Øµ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙƒØ±Ø±Ø©
        function checkDuplicates() {
            log('ğŸ” Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙƒØ±Ø±Ø©...', 'info');

            const duplicates = findDuplicates();

            if (duplicates.length === 0) {
                log('âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ù…ÙƒØ±Ø±Ø©', 'success');
                return;
            }

            log(`âš ï¸ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${duplicates.length} Ø±Ø³Ø§Ù„Ø© Ù…ÙƒØ±Ø±Ø©:`, 'warning');

            duplicates.forEach((dup, index) => {
                log(`${index + 1}. "${dup.original.content.slice(0, 50)}..." - ÙØ±Ù‚ Ø²Ù…Ù†ÙŠ: ${dup.timeDiff.toFixed(2)} Ø«Ø§Ù†ÙŠØ©`, 'warning');
                log(`   Ø§Ù„Ø£ØµÙ„ÙŠØ©: ${dup.original.id} (${dup.original.sender_type})`, 'info');
                log(`   Ø§Ù„Ù…ÙƒØ±Ø±Ø©: ${dup.duplicate.id} (${dup.duplicate.sender_type})`, 'info');
            });
        }

        // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø·ÙˆØ§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠØ©
        function analyzeTimestamps() {
            log('â° Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø·ÙˆØ§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠØ©...', 'info');

            const duplicates = findDuplicates();

            if (duplicates.length === 0) {
                log('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ù…ÙƒØ±Ø±Ø© Ù„Ù„ØªØ­Ù„ÙŠÙ„', 'info');
                return;
            }

            const timeDiffs = duplicates.map(d => d.timeDiff);
            const avgTimeDiff = timeDiffs.reduce((a, b) => a + b, 0) / timeDiffs.length;
            const minTimeDiff = Math.min(...timeDiffs);
            const maxTimeDiff = Math.max(...timeDiffs);

            log(`ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙØ±ÙˆÙ‚ Ø§Ù„Ø²Ù…Ù†ÙŠØ©:`, 'info');
            log(`   Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØ±Ù‚: ${avgTimeDiff.toFixed(2)} Ø«Ø§Ù†ÙŠØ©`, 'info');
            log(`   Ø£Ù‚Ù„ ÙØ±Ù‚: ${minTimeDiff.toFixed(2)} Ø«Ø§Ù†ÙŠØ©`, 'info');
            log(`   Ø£ÙƒØ¨Ø± ÙØ±Ù‚: ${maxTimeDiff.toFixed(2)} Ø«Ø§Ù†ÙŠØ©`, 'info');

            if (avgTimeDiff < 5) {
                log('ğŸ” Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹ - Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…ØªØ²Ø§Ù…Ù†Ø©', 'warning');
            }
        }

        // ÙØ­Øµ Ø³Ù„Ø§Ù…Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        async function checkDatabaseIntegrity() {
            try {
                log('ğŸ—„ï¸ Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø³Ù„Ø§Ù…Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');

                // ÙØ­Øµ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¯ÙˆÙ† facebook_message_id
                const withoutFbId = messages.filter(m => !m.facebook_message_id && m.sender_type !== 'customer');
                log(`ğŸ“Š Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¯ÙˆÙ† facebook_message_id: ${withoutFbId.length}`, 'info');

                // ÙØ­Øµ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ù†ÙØ³ facebook_message_id
                const fbIds = messages.filter(m => m.facebook_message_id).map(m => m.facebook_message_id);
                const duplicateFbIds = fbIds.filter((id, index) => fbIds.indexOf(id) !== index);

                if (duplicateFbIds.length > 0) {
                    log(`âš ï¸ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ù†ÙØ³ facebook_message_id: ${duplicateFbIds.length}`, 'warning');
                }

                log('âœ… Ø§Ù†ØªÙ‡Ù‰ ÙØ­Øµ Ø³Ù„Ø§Ù…Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
            } catch (error) {
                log(`âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`, 'error');
            }
        }

        // Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            log('ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª', 'info');
        }

        // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
        function getSenderLabel(senderType) {
            switch (senderType) {
                case 'admin': return 'ğŸ‘¨â€ğŸ’¼ Admin';
                case 'bot': return 'ğŸ¤– Bot';
                case 'customer': return 'ğŸ‘¤ Customer';
                default: return 'â“ Unknown';
            }
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffMs = now - time;
            const diffSecs = Math.floor(diffMs / 1000);
            const diffMins = Math.floor(diffSecs / 60);
            const diffHours = Math.floor(diffMins / 60);

            if (diffSecs < 60) return `${diffSecs} Ø«Ø§Ù†ÙŠØ©`;
            if (diffMins < 60) return `${diffMins} Ø¯Ù‚ÙŠÙ‚Ø©`;
            if (diffHours < 24) return `${diffHours} Ø³Ø§Ø¹Ø©`;
            return `${Math.floor(diffHours / 24)} ÙŠÙˆÙ…`;
        }

        // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
        setInterval(() => {
            refreshMessages();
        }, 30000);
    </script>
</body>
</html>
