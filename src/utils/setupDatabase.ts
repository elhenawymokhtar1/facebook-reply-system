import { supabase } from '@/integrations/supabase/client';

// ุฅูุดุงุก ุฌุฏูู ุงูููุชุฌุงุช ูุฅุฏุฑุงุฌ ุจูุงูุงุช ุชุฌุฑูุจูุฉ
export const setupProductsTable = async () => {
  try {
    console.log('๐ Setting up products table...');

    // ุฅูุดุงุก ุฌุฏูู ุงูููุชุฌุงุช
    const { error: createError } = await supabase.rpc('exec_sql', {
      sql: `
        CREATE TABLE IF NOT EXISTS products (
          id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
          name VARCHAR(255) NOT NULL,
          price DECIMAL(10,2) NOT NULL,
          description TEXT,
          color VARCHAR(100) NOT NULL,
          category VARCHAR(100) NOT NULL,
          image_url TEXT,
          is_available BOOLEAN DEFAULT true,
          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
          updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );

        -- ุฅูุดุงุก ููุงุฑุณ ููุจุญุซ ุงูุณุฑูุน
        CREATE INDEX IF NOT EXISTS idx_products_color ON products(color);
        CREATE INDEX IF NOT EXISTS idx_products_category ON products(category);
        CREATE INDEX IF NOT EXISTS idx_products_available ON products(is_available);
        CREATE INDEX IF NOT EXISTS idx_products_price ON products(price);

        -- ุฅูุดุงุก trigger ูุชุญุฏูุซ updated_at ุชููุงุฆูุงู
        CREATE OR REPLACE FUNCTION update_updated_at_column()
        RETURNS TRIGGER AS $$
        BEGIN
            NEW.updated_at = NOW();
            RETURN NEW;
        END;
        $$ language 'plpgsql';

        CREATE TRIGGER update_products_updated_at
            BEFORE UPDATE ON products
            FOR EACH ROW
            EXECUTE FUNCTION update_updated_at_column();
      `
    });

    if (createError) {
      console.error('Error creating products table:', createError);
      return false;
    }

    console.log('โ Products table created successfully');

    // ุฅุฏุฑุงุฌ ุจูุงูุงุช ุชุฌุฑูุจูุฉ
    const sampleProducts = [
      {
        name: 'ุญุฐุงุก ุฑูุงุถู ุฃุจูุถ ููุงุณูู',
        price: 450.00,
        description: 'ุญุฐุงุก ุฑูุงุถู ูุฑูุญ ููุงุณุชุฎุฏุงู ุงูููููุ ูุตููุน ูู ููุงุฏ ุนุงููุฉ ุงูุฌูุฏุฉ',
        color: 'ุฃุจูุถ',
        category: 'ุฑูุงุถู',
        image_url: 'https://files.easy-orders.net/1744641208557436357.jpg'
      },
      {
        name: 'ุญุฐุงุก ุฑูุงุถู ุฃุจูุถ ุนุตุฑู',
        price: 550.00,
        description: 'ุญุฐุงุก ุฑูุงุถู ุจุชุตููู ุนุตุฑู ูููุงุฏ ูุชุทูุฑุฉ',
        color: 'ุฃุจูุถ',
        category: 'ุฑูุงุถู',
        image_url: 'https://files.easy-orders.net/1744641208557436357.jpg'
      },
      {
        name: 'ุญุฐุงุก ููุงุณูู ุฃุจูุถ ุฑุณูู',
        price: 750.00,
        description: 'ุญุฐุงุก ููุงุณูู ุฃููู ููุงุณุจ ููููุงุณุจุงุช ุงูุฑุณููุฉ',
        color: 'ุฃุจูุถ',
        category: 'ููุงุณูู',
        image_url: 'https://files.easy-orders.net/1744641208557436357.jpg'
      },
      {
        name: 'ุญุฐุงุก ูุงุฌูุงู ุฃุจูุถ ูุฑูุญ',
        price: 320.00,
        description: 'ุญุฐุงุก ูุงุฌูุงู ูุฑูุญ ููุงุณุชุฎุฏุงู ุงููููู',
        color: 'ุฃุจูุถ',
        category: 'ูุงุฌูุงู',
        image_url: 'https://files.easy-orders.net/1744641208557436357.jpg'
      },
      {
        name: 'ุญุฐุงุก ุฑูุงุถู ุฃุณูุฏ ุฃููู',
        price: 480.00,
        description: 'ุญุฐุงุก ุฑูุงุถู ุฃุณูุฏ ุฃููู ููุฑูุญ',
        color: 'ุฃุณูุฏ',
        category: 'ุฑูุงุถู',
        image_url: 'https://files.easy-orders.net/1723117580290608498.jpg'
      },
      {
        name: 'ุญุฐุงุก ููุงุณูู ุจูู ุฌูุฏ',
        price: 680.00,
        description: 'ุญุฐุงุก ููุงุณูู ุจูู ูู ุงูุฌูุฏ ุงูุทุจูุนู',
        color: 'ุจูู',
        category: 'ููุงุณูู',
        image_url: 'https://files.easy-orders.net/1739181695020677812.jpg'
      },
      {
        name: 'ุญุฐุงุก ุฑูุงุถู ุฃุญูุฑ ุฌุฐุงุจ',
        price: 520.00,
        description: 'ุญุฐุงุก ุฑูุงุถู ุฃุญูุฑ ุจุชุตููู ุฌุฐุงุจ ูุนุตุฑู',
        color: 'ุฃุญูุฑ',
        category: 'ุฑูุงุถู',
        image_url: 'https://files.easy-orders.net/1744720320703143217.jpg'
      },
      {
        name: 'ุญุฐุงุก ุฑูุงุถู ุฃุฒุฑู ูููุฒ',
        price: 490.00,
        description: 'ุญุฐุงุก ุฑูุงุถู ุฃุฒุฑู ุจุชุตููู ูููุฒ ููุฑูุญ',
        color: 'ุฃุฒุฑู',
        category: 'ุฑูุงุถู',
        image_url: 'https://files.easy-orders.net/1723117554054321721.jpg'
      }
    ];

    // ุงูุชุญูู ูู ูุฌูุฏ ููุชุฌุงุช ูุณุจูุงู
    const { data: existingProducts, error: checkError } = await supabase
      .from('products')
      .select('id')
      .limit(1);

    if (checkError) {
      console.error('Error checking existing products:', checkError);
      return false;
    }

    if (existingProducts && existingProducts.length > 0) {
      console.log('โ Products already exist, skipping sample data insertion');
      return true;
    }

    // ุฅุฏุฑุงุฌ ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ
    const { error: insertError } = await supabase
      .from('products')
      .insert(sampleProducts);

    if (insertError) {
      console.error('Error inserting sample products:', insertError);
      return false;
    }

    console.log('โ Sample products inserted successfully');
    return true;

  } catch (error) {
    console.error('Error setting up products table:', error);
    return false;
  }
};



// ุฅุนุฏุงุฏ ูุธุงู ุงููุฆุงุช
export const setupCategoriesSystem = async () => {
  try {
    console.log('๐ Setting up categories system...');

    // ุฅูุดุงุก ุฌุฏูู ุงููุฆุงุช
    const { error: createError } = await supabase.rpc('exec_sql', {
      sql: `
        -- ุฌุฏูู ุงููุฆุงุช
        CREATE TABLE IF NOT EXISTS product_categories (
          id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
          name VARCHAR(100) NOT NULL UNIQUE,
          description TEXT,
          icon VARCHAR(50),
          color VARCHAR(20),
          is_active BOOLEAN DEFAULT true,
          sort_order INTEGER DEFAULT 0,
          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
          updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );

        -- ุฅูุดุงุก ููุงุฑุณ
        CREATE INDEX IF NOT EXISTS idx_product_categories_name ON product_categories(name);
        CREATE INDEX IF NOT EXISTS idx_product_categories_active ON product_categories(is_active);
        CREATE INDEX IF NOT EXISTS idx_product_categories_sort ON product_categories(sort_order);

        -- trigger ูุชุญุฏูุซ updated_at
        CREATE OR REPLACE FUNCTION update_categories_updated_at()
        RETURNS TRIGGER AS $$
        BEGIN
            NEW.updated_at = NOW();
            RETURN NEW;
        END;
        $$ language 'plpgsql';

        CREATE TRIGGER update_product_categories_updated_at
            BEFORE UPDATE ON product_categories
            FOR EACH ROW
            EXECUTE FUNCTION update_categories_updated_at();

        -- view ูุนุฑุถ ุงููุฆุงุช ูุน ุฅุญุตุงุฆูุงุช (ูุจุณุท)
        CREATE OR REPLACE VIEW categories_with_stats AS
        SELECT
            pc.id,
            pc.name,
            pc.description,
            pc.icon,
            pc.color,
            pc.is_active,
            pc.sort_order,
            pc.created_at,
            pc.updated_at,
            COALESCE(COUNT(p.id), 0) as total_products,
            COALESCE(COUNT(CASE WHEN p.is_available = true THEN 1 END), 0) as active_products,
            0 as total_stock
        FROM product_categories pc
        LEFT JOIN products p ON p.category = pc.name
        GROUP BY pc.id, pc.name, pc.description, pc.icon, pc.color, pc.is_active, pc.sort_order, pc.created_at, pc.updated_at
        ORDER BY pc.sort_order, pc.name;
      `
    });

    if (createError) {
      console.error('Error creating categories tables:', createError);
      return false;
    }

    console.log('โ Categories tables created successfully');

    // ุงูุชุญูู ูู ูุฌูุฏ ูุฆุงุช
    const { data: existingCategories, error: checkError } = await supabase
      .from('product_categories')
      .select('id')
      .limit(1);

    if (checkError) {
      console.error('Error checking existing categories:', checkError);
      return false;
    }

    if (existingCategories && existingCategories.length > 0) {
      console.log('โ Categories already exist');
      return true;
    }

    // ุฅุฏุฑุงุฌ ุงููุฆุงุช ุงูุงูุชุฑุงุถูุฉ
    const defaultCategories = [
      {
        name: 'ุฑูุงุถู',
        description: 'ุฃุญุฐูุฉ ุฑูุงุถูุฉ ูููุงุณุจุฉ ููุชูุงุฑูู ูุงูุฃูุดุทุฉ ุงูุฑูุงุถูุฉ',
        icon: 'activity',
        color: 'blue',
        sort_order: 1
      },
      {
        name: 'ููุงุณูู',
        description: 'ุฃุญุฐูุฉ ููุงุณูููุฉ ุฃูููุฉ ููุงุณุจุฉ ููููุงุณุจุงุช ุงูุฑุณููุฉ',
        icon: 'crown',
        color: 'purple',
        sort_order: 2
      },
      {
        name: 'ูุงุฌูุงู',
        description: 'ุฃุญุฐูุฉ ูุงุฌูุงู ูุฑูุญุฉ ููุงุณุชุฎุฏุงู ุงููููู',
        icon: 'coffee',
        color: 'green',
        sort_order: 3
      },
      {
        name: 'ุฑุณูู',
        description: 'ุฃุญุฐูุฉ ุฑุณููุฉ ูุงุฎุฑุฉ ููููุงุณุจุงุช ุงููููุฉ',
        icon: 'briefcase',
        color: 'gray',
        sort_order: 4
      }
    ];

    const { error: insertError } = await supabase
      .from('product_categories')
      .insert(defaultCategories);

    if (insertError) {
      console.error('Error inserting default categories:', insertError);
      return false;
    }

    console.log('โ Default categories inserted successfully');
    return true;

  } catch (error) {
    console.error('Error setting up categories system:', error);
    return false;
  }
};

// ุฏุงูุฉ ูุชุดุบูู ุงูุฅุนุฏุงุฏ
export const initializeDatabase = async () => {
  console.log('๐ Initializing database...');

  // ุฅุนุฏุงุฏ ุงููุธุงู ุงููุฏูู
  const oldSystemSuccess = await setupProductsTable();



  // ุฅุนุฏุงุฏ ูุธุงู ุงููุฆุงุช
  const categoriesSuccess = await setupCategoriesSystem();

  if (oldSystemSuccess && categoriesSuccess) {
    console.log('๐ Database initialization completed successfully!');
  } else {
    console.error('โ Database initialization failed!');
  }

  return oldSystemSuccess && categoriesSuccess;
};
